<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сыроварня Любимая</title>

  <!-- Firebase compat (как у вас было) -->
  <script defer src="/__/firebase/12.2.1/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-database-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-functions-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-messaging-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-storage-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-analytics-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-remote-config-compat.js"></script>
  <script defer src="/__/firebase/12.2.1/firebase-performance-compat.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <!-- Fonts and favicon -->
  <link rel="shortcut icon" href="https://uploads-ssl.webflow.com/602f50d140b9c71da633c706/603144419951234720610f4_favicon.png" type="icon/png" sizes="32x32" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* Вставлена ваша основная стилистика + мелкие правки */
    :root{
      --bg:#1e1e1e; --accent:#ffc300; --muted:#e5e5e5; --card:#2c2c2c; --radius:8px;
      --maxwidth:1200px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,Arial, sans-serif;background:var(--bg);color:var(--muted)}
    a{color:inherit}
    .container{max-width:var(--maxwidth);margin:0 auto;padding:0 18px}
    .app-header{display:flex;align-items:center;justify-content:space-between;padding:18px;border-bottom:1px solid #333;background:#171717}
    .header-logo{color:var(--accent);font-weight:700;font-size:22px}
    .app-nav{display:flex;gap:18px;align-items:center}
    .app-nav a{color:var(--muted);text-decoration:none;padding:8px;border-radius:6px}
    .button{background:var(--accent);color:#111;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    main{padding:36px 0;min-height:60vh}
    footer{padding:20px;border-top:1px solid #333;color:#bbb}
    /* sections */
    .home-banner{background:#2b2b2b;padding:28px;border-radius:10px;text-align:center}
    .home-banner h1{color:var(--accent);font-size:36px;margin-bottom:8px}
    /* catalog */
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;margin-top:18px}
    .product-card{background:var(--card);padding:12px;border-radius:10px;color:var(--muted);display:flex;flex-direction:column;gap:8px}
    .product-card img{width:100%;height:160px;object-fit:cover;border-radius:8px}
    .price{display:flex;justify-content:space-between;align-items:center}
    /* product detail */
    .product-detail-container{display:flex;gap:26px;flex-wrap:wrap}
    .product-detail-image{width:100%;max-width:520px;border-radius:8px}
    .product-detail-info{flex:1;min-width:280px}
    /* auth styles */
    .auth-container{max-width:920px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .auth-form{background:var(--card);padding:20px;border-radius:10px}
    .auth-form h2{color:var(--accent);margin-bottom:12px}
    .form-group{margin-bottom:12px}
    input,textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:var(--muted)}
    .form-error{color:#e14747;min-height:18px;margin-top:6px}
    /* cart */
    .cart-summary{background:var(--card);padding:18px;border-radius:8px;margin-top:12px}
    /* responsive */
    @media(max-width:900px){ .auth-container{grid-template-columns:1fr} .product-detail-container{flex-direction:column} .app-nav{display:none} .burger-menu{display:block} }
  </style>
</head>

<body>
  <header class="app-header container">
    <div class="header-left">
      <a class="header-logo" href="#/">Сыроварня Любимая</a>
    </div>
    <nav class="app-nav">
      <a href="#/" class="app-nav-link">Главная</a>
      <a href="#about" class="app-nav-link">О нас</a>
      <a href="#catalog" class="app-nav-link">Продукция</a>
      <a href="#contacts" class="app-nav-link">Контакты</a>
      <a href="#cart" class="app-nav-link">Корзина</a>
    </nav>
    <div class="nav-actions">
      <a href="#auth" id="auth-link" class="button">Войти</a>
    </div>
  </header>

  <main class="container" id="app-root">
    <!-- Содержимое рендерится через ваши шаблоны в app.js -->
  </main>

  <footer class="app-footer container">
    <img alt="logo" src="https://uploads-ssl.webflow.com/602f50d140b9c71da633c706/603144419951234720610f4_favicon.png" style="height:40px">
    <div>© 2025 Сыроварня Любимая</div>
    <div>Телефон: <a href="tel:+79032323476" style="color:var(--accent)">+7 (903) 232-34-76</a></div>
  </footer>

  <!-- TEMPLATES -->
  <template id="home-page-template">
    <div class="home-banner">
      <h1>ЧАСТНАЯ СЫРОВАРНЯ</h1>
      <p style="color:#cfcfcf;max-width:900px;margin:8px auto">Наша сыроварня использует сырье высшего качества... (текст из new.txt)</p>
      <a href="#catalog" class="button">Смотреть продукцию</a>
    </div>
  </template>

  <template id="catalog-page-template">
    <h1 class="page-title" style="color:var(--accent)">Наша Продукция</h1>
    <div id="product-grid" class="product-grid"></div>
  </template>

  <template id="product-page-template">
    <div class="product-detail-container">
      <div>
        <img src="" alt="" class="product-detail-image">
      </div>
      <div class="product-detail-info">
        <h1 class="product-detail-name"></h1>
        <p class="product-detail-desc"></p>
        <p class="product-detail-price" style="font-size:20px;color:var(--accent)"></p>
        <div style="margin-top:18px">
          <label>Кол-во: <input id="product-qty" type="number" value="1" min="1" style="width:70px"></label>
          <button class="button" id="product-add-btn">Добавить в корзину</button>
        </div>
      </div>
    </div>
  </template>

  <!-- AUTH template: телефонный вход/регистрация -->
  <template id="auth-page-template">
    <div class="auth-container">
      <form id="phone-send-form" class="auth-form">
        <h2>Вход / Регистрация</h2>
        <div class="form-group">
          <label>Номер телефона</label>
          <input id="phone-number" type="tel" placeholder="+7 903 123 45 67" required>
        </div>
        <div id="send-error" class="form-error"></div>
        <!-- recaptcha-контейнер -->
        <div id="recaptcha-container"></div>
        <div class="form-group">
          <button id="send-code-button" class="button" type="submit">Отправить код</button>
        </div>
        <p class="small">Мы отправим SMS с кодом. Для тестирования можно настроить тест-номера в Firebase Console.</p>
      </form>

      <form id="phone-verify-form" class="auth-form" style="display:none;">
        <h2>Подтвердите код</h2>
        <div class="form-group">
          <label>Код из SMS</label>
          <input id="sms-code" type="text" inputmode="numeric" placeholder="Введите код" required>
        </div>
        <div class="form-group">
          <label>Ваше имя (необязательно)</label>
          <input id="display-name" type="text" placeholder="Иван Иванов">
        </div>
        <div id="verify-error" class="form-error"></div>
        <div class="form-group">
          <button id="confirm-code-button" class="button" type="submit">Подтвердить и войти</button>
        </div>
        <div style="margin-top:8px">
          <button id="resend-code" class="button secondary" type="button" style="background:transparent;color:var(--muted)">Отправить код снова</button>
        </div>
      </form>
    </div>
  </template>

  <template id="cart-page-template">
    <h1 class="page-title" style="color:var(--accent)">Корзина</h1>
    <div id="cart-items-container"></div>
    <div id="cart-summary" class="cart-summary"></div>
  </template>

  <template id="profile-page-template">
    <h1 class="page-title" style="color:var(--accent)">Личный кабинет</h1>
    <p>Вы вошли как: <span id="profile-phone"></span></p>
    <div id="order-history"></div>
    <div style="margin-top:16px">
      <button id="logout-button" class="button">Выйти</button>
    </div>
  </template>

  <script>
    /*
      Phone auth logic (Firebase compat). Этот скрипт работает с формами в #auth-page-template.
      Подключается к глобальному firebase (init.js уже инициализирует SDK).
      Что делает:
       - инициализирует invisible reCAPTCHA в контейнере 'recaptcha-container'
       - отправляет код методом signInWithPhoneNumber
       - подтверждает код и создаёт/обновляет документ пользователя в Firestore
    */

    (function () {
      // confirmationResult будет глобально храниться здесь
      let confirmationResult = null;

      // helper: показать/скрыть формы
      function showSendForm() {
        document.getElementById('phone-send-form').style.display = '';
        document.getElementById('phone-verify-form').style.display = 'none';
      }
      function showVerifyForm() {
        document.getElementById('phone-send-form').style.display = 'none';
        document.getElementById('phone-verify-form').style.display = '';
      }

      // инициализация reCAPTCHA (invisible)
      function initRecaptcha() {
        if (!window.recaptchaVerifier) {
          window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible',
            'callback': (response) => { /* invisible callback */ }
          });
          // render widget (не обязательно хранить id)
          window.recaptchaVerifier.render().catch(()=>{});
        }
        return window.recaptchaVerifier;
      }

      // Отправка кода
      async function sendCode(e) {
        if (e) e.preventDefault();
        const phone = (document.getElementById('phone-number')||{}).value || '';
        const sendError = document.getElementById('send-error');
        sendError.textContent = '';
        if (!phone.trim()) { sendError.textContent = 'Введите номер телефона'; return; }
        try {
          initRecaptcha();
          // signInWithPhoneNumber returns promise with confirmationResult
          confirmationResult = await firebase.auth().signInWithPhoneNumber(phone.trim(), window.recaptchaVerifier);
          window.confirmationResult = confirmationResult; // глобально для инспекции
          showVerifyForm();
        } catch (err) {
          console.error('sendCode error', err);
          // иногда нужно выполнить recaptchaVerifier.clear() при повторной попытке; но в compat нет метода clear
          sendError.textContent = err && err.message ? err.message : 'Ошибка отправки кода';
        }
      }

      // Подтверждение кода
      async function confirmCode(e) {
        if (e) e.preventDefault();
        const code = (document.getElementById('sms-code')||{}).value || '';
        const name = (document.getElementById('display-name')||{}).value || '';
        const verifyError = document.getElementById('verify-error');
        verifyError.textContent = '';
        if (!code.trim()) { verifyError.textContent = 'Введите код из SMS'; return; }
        if (!window.confirmationResult) { verifyError.textContent = 'Сначала отправьте код'; return; }
        try {
          const credential = await window.confirmationResult.confirm(code.trim());
          const user = credential.user;
          // Сохраняем профиль в Firestore (совместимый SDK)
          try {
            const db = firebase.firestore();
            const userRef = db.collection('users').doc(user.uid);
            const payload = {
              phone: user.phoneNumber || null,
              displayName: name || (user.displayName || null),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await userRef.set(payload, { merge: true });
          } catch (dbErr) {
            console.error('firestore save error', dbErr);
          }
          // обновим интерфейс: перенаправим на профиль
          location.hash = '#profile';
          // можно показать уведомление
          console.log('User signed in:', user.uid, user.phoneNumber);
        } catch (err) {
          console.error('confirmCode error', err);
          verifyError.textContent = err && err.message ? err.message : 'Неверный код';
        }
      }

      // Повторная отправка кода — создаём новый reCAPTCHA и заново вызываем send
      async function resendCode() {
        const phone = (document.getElementById('phone-number')||{}).value || '';
        if (!phone.trim()) { document.getElementById('send-error').textContent = 'Введите номер телефона'; return; }
        try {
          // сброс reCAPTCHA: удаляем старый инстанс, если есть
          try { if (window.recaptchaVerifier && window.recaptchaVerifier.clear) window.recaptchaVerifier.clear(); } catch(err){}
          window.recaptchaVerifier = null;
          await sendCode();
        } catch (err) {
          console.error(err);
          document.getElementById('send-error').textContent = err.message || 'Ошибка при повторной отправке';
        }
      }

      // Делегированные обработчики: формы могут появляться динамически, поэтому слушаем document
      document.addEventListener('submit', function (ev) {
        const form = ev.target;
        if (form && form.id === 'phone-send-form') { sendCode(ev); }
        else if (form && form.id === 'phone-verify-form') { confirmCode(ev); }
      });

      document.addEventListener('click', function (ev) {
        const t = ev.target;
        if (t && t.id === 'resend-code') { resendCode(); }
      });

      // Подписка на изменение состояния аутентификации: обновляет ссылку "Войти" и профиль
      firebase.auth().onAuthStateChanged(async function (user) {
        const authLink = document.getElementById('auth-link');
        if (user) {
          // показываем телефон в ссылке
          authLink.textContent = user.phoneNumber || 'Профиль';
          authLink.href = '#profile';
          // если профиль страница открыта — обновим её данные
          if (location.hash === '#profile') {
            renderProfilePage(user);
          }
        } else {
          authLink.textContent = 'Войти';
          authLink.href = '#auth';
        }
      });

      // Простая функция рендера профиля (если шаблон рендерится вашим app.js, можно убрать)
      async function renderProfilePage(user) {
        // Если в DOM есть шаблон profile-page-template, заполним данные
        const tpl = document.getElementById('profile-page-template');
        if (!tpl) return;
        const root = document.getElementById('app-root');
        root.innerHTML = '';
        root.appendChild(tpl.content.cloneNode(true));
        document.getElementById('profile-phone').textContent = user ? (user.phoneNumber || '') : '';
        // logout
        const btn = document.getElementById('logout-button');
        if (btn) btn.addEventListener('click', function () { firebase.auth().signOut(); location.hash = '#/'; });
        // загрузим историю заказов (если есть Firestore и коллекция orders с полем userId)
        try {
          const db = firebase.firestore();
          const ordersSnap = await db.collection('orders').where('userId', '==', user.uid).get();
          const container = document.getElementById('order-history');
          if (container) {
            if (ordersSnap.empty) {
              container.innerHTML = '<p>У вас ещё нет заказов.</p>';
            } else {
              container.innerHTML = '';
              ordersSnap.forEach(doc => {
                const data = doc.data();
                const el = document.createElement('div');
                el.className = 'order-history-item';
                el.innerHTML = '<p><strong>Заказ:</strong> ' + doc.id + '</p><p>Сумма: ' + (data.totalAmount || '-') + ' ₽</p><p>Статус: ' + (data.status || '-') + '</p>';
                container.appendChild(el);
              });
            }
          }
        } catch (err) {
          console.error('load orders error', err);
        }
      }

      // При загрузке страницы, если хеш #auth или #profile — рендерим соответствующие шаблоны.
      window.addEventListener('hashchange', function () {
        if (location.hash === '#auth') {
          const tpl = document.getElementById('auth-page-template');
          if (tpl) {
            const root = document.getElementById('app-root');
            root.innerHTML = '';
            root.appendChild(tpl.content.cloneNode(true));
            // ensure recaptcha is ready
            initRecaptcha();
            showSendForm();
          }
        } else if (location.hash === '#profile') {
          const user = firebase.auth().currentUser;
          if (user) renderProfilePage(user);
          else location.hash = '#auth';
        } else if (location.hash === '#catalog' || location.hash === '#/') {
          // делегируем рендеринг каталога вашему app.js, если он есть. Если нет — используйте шаблон home
          const tpl = document.getElementById('home-page-template');
          if (tpl) {
            const root = document.getElementById('app-root');
            root.innerHTML = '';
            root.appendChild(tpl.content.cloneNode(true));
          }
        }
      });

      // При первой загрузке — симулируем хеш change
      window.addEventListener('load', function () {
        if (!location.hash) location.hash = '#/';
        // trigger initial routing
        const ev = new Event('hashchange'); window.dispatchEvent(ev);
      });
    })();
  </script>

  <!-- Ваш app.js (если у вас есть модульный скрипт) -->
  <script type="module" src="app.js"></script>
</body>
</html>
